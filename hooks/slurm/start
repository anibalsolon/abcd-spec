#!/bin/bash

#terminate if any command fails (and any command piped)
#I don't want not finding any #PBS to fail
#set -e
#set -o pipefail

rm -f exit-code

echo "#!/bin/bash" > _main

[ -f jobheader.sh ] && sh ./jobheader.sh >> _main

grep --regexp="^#PBS" main >> _main

#copy smon to workdir so that resource doesn't need to have it in the path
cp -aL $(which smon) .

if [ -d /oasis/scratch/comet ];
then
	#use comet scratch directory (SSD) for singularity_localcache
	echo "export SINGULARITY_LOCALCACHEDIR=/scratch/\$USER/\$SLURM_JOBID" >> _main
	#can't set this via .bashrc for some reason
	echo "module load python/2.7.10" >> _main
fi

rm -f _smon.out
echo "./smon &" >> _main
echo "smonpid=\$!" >> _main

echo "./main" >> _main
echo "echo \$? > exit-code" >> _main
chmod +x main #in case user fogets it

echo "kill \$smonpid" >> _main

sbatch --parsable -o "slurm-%j.log" -e "slurm-%j.err" _main > jobid
