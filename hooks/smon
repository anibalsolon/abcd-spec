#!/usr/bin/env python

import os
import subprocess
import json
import time
import sys

print("starting ps monitor")

while True:
    sid=os.getsid(os.getpid())
    out=subprocess.check_output(["ps", "-s", str(sid), "ho", "pid,pcpu,pmem,rss,vsz,cmd"])
    stats = []
    for line in out.split("\n"):
        if line == "":
            continue
        tokens=line.split()
        pid=tokens[0]
        pcpu=float(tokens[1])
        pmem=float(tokens[2])
        rss=int(tokens[3])
        vsz=int(tokens[4])
        cmd=' '.join(tokens[5:])
        if pcpu > 0 or pmem > 0:
            stats.append({"pid": pid, "pcpu": pcpu, "pmem": pmem, "rss": rss, "vsz": vsz, "cmd": cmd})

    #print(json.dumps(stats, indent=4))
    #sys.stdout.flush()

    with open("smon.json", "w") as outfile:
        json.dump(stats, outfile, indent=4)
        time.sleep(5)
