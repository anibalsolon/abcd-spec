#!/usr/bin/env python

import os
import subprocess
import json
import time
import sys

name="_smon.out"
delay=60
print("updating "+name+" every "+str(delay)+" seconds")

def get_size(start_path = '.'):
    total_size = 0
    for dirpath, dirnames, filenames in os.walk(start_path):
        for f in filenames:
            fp = os.path.join(dirpath, f)
            total_size += os.path.getsize(fp)
    return total_size

with open(name, "w") as outfile:

    while True:

        #query process under current session
        processes = []
        sid=os.getsid(os.getpid())
        out=subprocess.check_output(["ps", "-s", str(sid), "ho", "pid,pcpu,pmem,rss,vsz,etime,cmd"])
        for line in out.split("\n"):
            if line == "":
                continue
            tokens=line.split()
            pid=tokens[0]
            pcpu=float(tokens[1])
            pmem=float(tokens[2])
            rss=int(tokens[3])
            vsz=int(tokens[4])
            etime=tokens[5]
            cmd=' '.join(tokens[6:])

            if etime != "00:00": #pcpu > 0 or pmem > 0:
                processes.append({"pid": pid, "pcpu": pcpu, "pmem": pmem, "rss": rss, "vsz": vsz, "etime": etime, "cmd": cmd})

        #debug..
        #print(json.dumps(processes, indent=4))
        #sys.stdout.flush()

        #query disk usage
        disks = []
        out=subprocess.check_output(["du"])
        for line in out.split("\n"):
            if line == "":
                continue
            tokens=line.split()
            size=int(tokens[0])
            path=tokens[1]
            disks.append({"path": path, "size": size})

        #debug
        #print(json.dumps(disks, indent=4))
        #sys.stdout.flush()

        outfile.write(str(time.time())+"\n")
        json.dump({"processes": processes, "disks": disks}, outfile)
        outfile.write("\n")
        outfile.flush()

        time.sleep(delay)
